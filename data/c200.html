<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <link href="https://vjs.zencdn.net/8.3.0/video-js.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <title>Tapo C200</title>
    <style>
        div{
            display: flex;
            justify-content: center;
        }
    </style>
</head>

<body>
    <video-js id="live-cam2" class="vjs-default-skin" controls muted autoplay
            width="640" height="360" data-setup="{}">
        <source src="hls/c200.m3u8" type="application/x-mpegURL" />
        <p class="vjs-no-js">
            この動画を見るためには JavaScript を有効にし、
            HTML5 の video タグをサポートするブラウザを使って下さい。
        </p>
    </video-js>
    <div id="app">
        <button v-show="!isRecording" v-on:click="requestRecStart" style="background-color: #008CBA; color:azure;">Recording Start</button>
        <button v-show="isRecording" v-on:click="requestRecStop" style="background-color: #f44336; color:azure;">Recoding Stop</button>
    </div>
    <script src="https://vjs.zencdn.net/8.3.0/video.min.js"></script>
    <script>
        var player = videojs('live-cam2');
    </script>
    <script>
        let app = new Vue({
            el: '#app',
            data(){
                return {
                    filename: "",
                    isRecording: false,
                    autoStopTime: 30000,
                }
            },
            mounted () {
                window.addEventListener('beforeunload', () => {
                    this.requestRecStop()
                })
            },
            destroyed () {
                window.removeEventListener('beforeunload', () => {
                    this.requestRecStop()
                })
            },
            methods: {
                requestRecStart(){
                    if (this.isRecording) {
                        console.log('now recording!')
                    } else {
                        console.log('request start recording')
                        axios
                        .get("control/record/start?app=livecam&name=c200&rec=rec1")
                        .then(response => {
                            console.log('status:',response.status);
                            console.log('body:', response.data);
                            if (response.status == '200') {
                                this.filename=response.data;
                                this.isRecording=true;
                                setTimeout(()=>{
                                    this.requestRecStop();
                                }, this.autoStopTime);
                            }else if (response.status == '204') {
                                alert("現在録画中のため、開始できません");
                            }else{
                                console.log('recording start failed.');
                            }
                        }).catch(err => {
                            console.log('error occured:', err);
                        });
                    }
                },
                requestRecStop(){
                    if (!this.isRecording) {
                        console.log('now not recording!!')
                    } else {
                        console.log('request stop recording')
                        axios
                        .get("control/record/stop?app=livecam&name=c200&rec=rec1")
                        .then(response => {
                            console.log('status:',response.status);
                            console.log('body:', response.data);
                            if (response.status == '200') {
                                this.filename='';
                                this.isRecording=false;
                            }else if (response.status == '204') {
                                alert("現在録画していないため、停止できません");
                            }else{
                                console.log('recording stop failed.');
                            }
                        }).catch(err => {
                            console.log('error occured:', err);
                        });
                    }
                }
            }
        })
    </script>
</body>
</html>